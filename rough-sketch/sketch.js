// Project Title
// Your Name
// Date
//
// Extra for Experts:
// - describe what you did to take this project "above and beyond"

let player;
let bg, bgGround, bgResources;
// let player;
let obstacle1, obstacle2, obstacle3, obstacle4;
let obstacles = [obstacle1, obstacle2, obstacle3, obstacle4];
let guns;
let globalBullets = [];
let walls, wallImg;
let tileMap;
let camOffsetX, camOffsetY;

//tiles
let taigaTrees, taigaTreeImg, stones, yellowTrees, yellowTreeImg, bigRocks, bigRockImg, smallRocks, smallRockImg;
let flowerBaskets, flowerBasketImg;
let naturalResources;

//enemies
let enemies, enemy;


//bullets
let bullets;


//initializing guns
let shotgun, pistol, ak47;
let shotgunImg;
let pistolImg;
let shotgunIcon, pistolIcon, shotgunIconImg, pistolIconImg;
let equippedGuns = [];

//temp vars
let ball, extraCanvas;

//gui elements
let healthBar, box1, box1Img, box2, box2Img, box3, box3Img, inventory;

function preload() {
  // bgGround = loadImage("assets/test-maps/tile-map-ground-1.png");
  // bgResources = loadImage("assets/test-maps/tile-map-resources-1.png")
  bg = loadImage("assets/test-maps/base-layer-1.png")
  wallImg = loadImage("assets/wall.png");
  taigaTreeImg = loadImage("assets/tile-images/taiga_tree.png")
  bigRockImg = loadImage("assets/tile-images/big-rock.png");
  yellowTreeImg = loadImage("assets/tile-images/yellow-tree.png");
  flowerBasketImg = loadImage("assets/tile-images/flower-basket.png");
  smallRockImg = loadImage("assets/tile-images/small-rock.png");
  shotgunImg = loadImage("assets/sprite-images/shotgun-4.png");
  pistolImg = loadImage("assets/sprite-images/pistol-2.png");
  pistolIconImg = loadImage("assets/icons/pistol.png");
  shotgunIconImg = loadImage("assets/icons/shotgun.png");
  box1Img = loadImage("assets/inventory/inventory-box-blue.png");

}

function setup() {

  angleMode(DEGREES);

  bg.width *= 0.5;
  bg.height *= 0.5;


  new Canvas(windowWidth, windowHeight);

  //creating player sprite
  player = new Sprite(1500, 1800);
  player.w = 85;
  player.h = 85;
  // player.diameter = 125;
  // player.autoDraw = false;
  // player.debug = true;
  player.color = "black";
  player.mass = 1;
  player.collider = "d";
  player.bounciness = 0;
  player.rotationLock = true;
  player.friction = 0;
  player.drag = 0;
  player.scale = 0.25;
  player.layer = 5;
  player.health = 20;
  // player.debug = true;
  // player.img = "assets/ball-img.png";
  

  //enemies
  enemies = new Group();
  enemies.w = 72;
  enemies.h = 72;
  enemies.mass = 1;
  enemies.collider = "d";
  enemies.bounciness = 0;
  enemies.rotationLock = true;
  enemies.friction = 0;
  enemies.drag = 0;
  enemies.scale = 0.25;
  enemies.layer = 5;
  enemy = new enemies.Sprite(50, 50);


  //creating gun
  guns = new Group();
  // guns.mass = 1000;
  // guns.collider = "n";
  guns.equipped = false;


  //bullets
  bullets = new Group();

  //gui
  initGui();

  //guns creation
  initGuns();
  // shotgun = new guns.Sprite(player.x, player.y);
  // shotgun.img = shotgunImg;
  // shotgun.removeColliders();
  // shotgun.offset.y += -5;
  // shotgun.offset.x += 35;
  // shotgun.scale = 0.9;
  // shotgun.layer = 2;
  // shotgun.gunType = "shotgun";
  // shotgun.range = 25;
  // shotgun.len = 53;
  // shotgun.rotationLock = true;
  // shotgun.bulletArray = [];

  //pistol
  pistol = new guns.Sprite(player.x - 100, player.y);
  pistol.img = pistolImg;
  pistol.removeColliders();
  pistol.layer = 2;
  pistol.offset.x = 33;
  pistol.len = 43;
  pistol.scale = 0.6;
  pistol.gunType = "pistol";
  pistol.range = 70;
  pistol.bulletArray = [];

  //ak47
  ak47 = new guns.Sprite(500, 200);
  ak47.width = 50;
  ak47.height = 10;
  ak47.layer = 2;
  // ak47.offset.x = 25;
  ak47.gunType = "ak47";
  ak47.range = 40;
  // ak47.bulletArray = [];

  for (let gun of guns) {
    gun.bulletArray = [];
    // gun.offset.x = 25;
    gun.bounciness = 0;
    gun.friction = 0;
    gun.drag = 0;
    gun.rotationDrag = 0;
  }

  //tilemap
  naturalResources = new Group();
  naturalResources.collider = "s";
  naturalResources.bounciness = 0;

  //tree tiles
  taigaTrees = new naturalResources.Group();
  taigaTrees.img = taigaTreeImg;
  taigaTrees.tile = "t";

  yellowTrees = new naturalResources.Group();
  yellowTrees.img = yellowTreeImg;
  yellowTrees.tile = "y";


  //rock tiles
  bigRocks = new naturalResources.Group()
  bigRocks.img = bigRockImg;
  bigRocks.tile = "b";

  smallRocks = new naturalResources.Group();
  smallRocks.img = smallRockImg;
  smallRocks.tile = "s";
  

  //random resources
  flowerBaskets = new naturalResources.Group()
  flowerBaskets.img = flowerBasketImg;
  flowerBaskets.tile = "f";


  tileMap = new Tiles(
    [
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      ".............................................t.................................................................y...................................................................................................................................................................",
      "..................b............................................................t...................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "............................................................y......................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      ".............s.......................s.............................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "............................................................................................b...................t..................................................................................................................................................................",
      ".............................................................t.....................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "................................................................................y..................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      ".......................t...........................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "............................................b......................................................................................................................................................................................................................................",
      "....................................................................t..............................................................................................................................................................................................................",
      ".....................................................................................................t.............................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "..................y.......................................................f........................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "..............................................t..............................................s.....................................................................................................................................................................................",
      ".................................................................................................................b.................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................t...............................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...........................................................y................t......................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      ".....................y..................................................................................t..........................................................................................................................................................................",
      "...........................................................................y.......................................................................................................................................................................................................",
      ".............................................b.....................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "............t.................................s....................................................................................................................................................................................................................................",
      "..............................f..............................................................................y.....................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "..........................................................................y........................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "................................................................................................t..................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................s.........................t.....................................................................................................................................................................................................................................",
      ".........................................................y.........................................................................................................................................................................................................................",
      "..............................................................................................................s....................................................................................................................................................................",
      ".........................................................................b.........................................................................................................................................................................................................",
      "..........y........................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "..................................................................................................t................................................................................................................................................................................",
      "........................................t..........................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "..............................................................t..................y.................................................................................................................................................................................................",
      "..................t................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "............................................................................................................f......................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      ".....................y.............................................................................................................................................................................................................................................................",
      "...........................................s...........y.......................t...................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...........................t.......................................................................................................................................................................................................................................................",
      ".................................................................................................t.................................................................................................................................................................................",
      "......................................................t....................b.......................................................................................................................................................................................................",
      ".........b.........................................................................................................................................................................................................................................................................",
      "..................................f................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "..................................................................................y.............................s..................................................................................................................................................................",
      "..................................y................................................................................................................................................................................................................................................",
      "....................................................b......................................t.......................................................................................................................................................................................",
      "........................t..........................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "..............................................................................................................y....................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "............................................s..............y.......................................................................................................................................................................................................................",
      "..............t.................t.............s....................................................................................................................................................................................................................................",
      ".....................................................................t.............................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "........................................................................................................................s..........................................................................................................................................................",
      "..................................................................................................b................................................................................................................................................................................",
      ".......................................s...........................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "......................................y.....................t......................................................................................................................................................................................................................",
      "..........t........................................................................................................................................................................................................................................................................",
      ".....................................................................................t..........................b..................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "........................................................................y......................................................b...................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "........................b...................................................................................y......................................................................................................................................................................",
      "......................................................t............................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "..........................................................................................t........................................................................................................................................................................................",
      ".......................t...........................................................................................................................................................................................................................................................",
      "....................................................................y.........................................t....................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "............b......................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "....................................y....................b.........................................................................................................................................................................................................................",
      "...............................................................................................t...................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...........................................f...............................b.......................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "............................................................................................................b......................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "............................s.............................................f........................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "................................................y..................................................................................................................................................................................................................................",
      ".............................................................................t.....................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
      "...................................................................................................................................................................................................................................................................................",
    ],
    0,
    0,
    35,
    35
    );
    
  for(let tree of taigaTrees) {
    tree.removeColliders();
    tree.addCollider(0, -20, 100, 140);
    tree.addCollider(0, 85, 40, 60)
    tree.layer = 0;
    tree.scale *= 0.45;
  }
  for(let rock of bigRocks) {
    rock.removeColliders();
    rock.addCollider(-5, -90, 115, 100)
    rock.addCollider(76, 5, 50, 135);
    rock.addCollider(-80, 18, 40, 130)
    rock.addCollider(-7, 70, 110, 80);
    rock.layer = 0;
    rock.scale *= 0.3;
  }
  for(let rock of smallRocks) {
    rock.removeColliders();
    rock.addCollider(0, -15, 93, 100);
    rock.layer = 0;
    rock.scale *= 0.3;
  }
  for(let basket of flowerBaskets) {
    basket.removeColliders();
    basket.addCollider(5, 6, 235, 120);
    basket.layer = 0;
    basket.scale = 0.25;
  }
  for(let tree of yellowTrees) {
    tree.removeColliders();
    tree.addCollider(0, -30, 100, 190);
    tree.addCollider(0, 93, 50, 53);
    tree.layer = 0;
    tree.scale = 0.4;
  }

  // allSprites.autoDraw = false;
  camera.zoom = 1.4;
  camera.x = player.x;
  camera.y = player.y;

  shotgun.icon = shotgunIcon;
  // player.autoDraw = false;
}

function draw() {
  clear();
  
  
  background(10);
  noStroke();
  camera.on();
  
  camera.x = (player.x);
  camera.y = (player.y);
  updateGui();
  image(bg, 0, 0);
  // player.draw();
  updatePlayerMovement();
  // camera.moveTo(player, 1.5);

  camera.off();
  updateGuns();

  
  // box1.draw();
  // updateEnemies();
  // walls.draw();
  // guns.draw()

  // image(box1Img, 100, 100);
  // console.log(player.speed);
}

let spd = 0;
let accel = 0.1;
function updatePlayerMovement() {
  if (keyIsPressed) {
    if (keyIsDown(87)) {
      // player.moveTowards(player.position.x, player.position.y - 0.5, spd);
      player.direction = -90;
    }
    if (keyIsDown(83)) {
      // player.moveTowards(player.position.x, player.position.y + 0.1, spd);
      player.direction = 90;
    }
    if (keyIsDown(68)) {
      // player.moveTowards(player.position.x + 1, player.position.y, spd);
      player.direction = 0;
    }
    if (keyIsDown(65)) {
      // player.moveTowards(player.position.x - 1, player.position.y, spd);
      player.direction = 180;
    }
    if (keyIsDown(87) && keyIsDown(68)) {
      // player.moveTowards(player.position.x + 1, player.position.y - 1, spd);
      player.direction = -45;
    }
    if (keyIsDown(87) && keyIsDown(65)) {
      // player.moveTowards(player.position.x - 1, player.position.y - 1, spd);
      player.direction = -135;
    }
    if (keyIsDown(83) && keyIsDown(68)) {
      // player.moveTowards(player.position.x + 1, player.position.y + 1, spd);
      player.direction = 45;
    }
    if (keyIsDown(83) && keyIsDown(65)) {
      // player.moveTowards(player.position.x - 1, player.position.y + 1, spd);
      player.direction = 135;
    }
    player.speed = spd;
    if(spd < 4) {
      spd += accel;
    }
  }
  else {
    player.speed = 0;
    spd = 0;
  }

}


function updateGuns() {
  for (let gun of guns) {
    if (gun.equipped === false && kb.presses("e") && dist(player.x, player.y, gun.x, gun.y) < 50) {
      equipGun(gun, player);
    }
    else if (gun.equipped === true && kb.presses("e")){
      unequipGun(gun);
    }
    else if (gun.equipped) {
      //update gun rotation
      gun.pos.x = player.pos.x;
      gun.pos.y = player.pos.y;
      // gun.rotation = player.rotation;
      // new GlueJoint(player, gun);
      gun.rotateTowards(mouse, 1.2, 1);

      //shooting bullets when mouse pressed
      if (mouse.presses()) {
        shootBullet(gun);
      }

      //updating bullets
      updateBullets(gun);
    }
  }
}

function equipGun(gun, player) {
  gun.equipped = true;
  gun.equip();
  gun.pos.x = player.pos.x;
  gun.pos.y = player.pos.y;
  gun.layer = 6;
  // gun.rotation = player.rotation;
  // new GlueJoint(player, gun);
  gun.rotateTowards(mouse, 1.2, 1);
  equippedGuns.push(gun);
}

function unequipGun(gun) {
  // player.joints.removeAll();
  gun.equipped = false;
  gun.unequip();
  gun.velocity.x = 0;
  gun.velocity.y = 0;
  gun.rotationDrag = 0;
  gun.rotationSpeed = 0;
  gun.layer = 2;
  gun.icon.visible = false;
}

function shootBullet(gun) {
  if(gun.gunType === "shotgun") {
    for (let i = 0; i <= 10; i++) {

      //position from an angle
      let bulletTemp = p5.Vector.fromAngle(radians(gun.rotation), gun.len);
      let gunPosTemp = createVector(gun.x, gun.y);
      let bulletPos = p5.Vector.add(bulletTemp, gunPosTemp);
      // bulletPos.setMag(1);

      let bullet = new bullets.Sprite(bulletPos.x, bulletPos.y);

      bullet.diameter = 5;
      bullet.color = "white";
      bullet.direction = gun.rotation + random(-10,10);
      bullet.speed = random(8, 10);
      bullet.collider = "d";
      bullet.layer = 1;
      bullet.bounce = 0.8;
      bullet.life = gun.range + random(-5, 5);
      bullet.mass = 5;  
      gun.bulletArray.push(bullet);
    }
  }
  if (gun.gunType === "pistol") {

    //position from an angle
    let bulletTemp = p5.Vector.fromAngle(radians(gun.rotation), gun.len);
    let gunPosTemp = createVector(gun.x, gun.y);
    let bulletPos = p5.Vector.add(bulletTemp, gunPosTemp);

    let bullet = new bullets.Sprite(bulletPos.x, bulletPos.y);

    bullet.diameter = 6;
    bullet.color = "yellow";
    bullet.direction = gun.rotation;
    bullet.speed = random(10, 12);
    bullet.collider = "d";
    bullet.layer = 1;
    bullet.life = gun.range;
    bullet.mass = 5;
    gun.bulletArray.push(bullet);
  }
  
  if (gun.gunType === "ak47") {

    //position from an angle
    let bulletTemp = p5.Vector.fromAngle(radians(gun.rotation), gun.width);
    let gunPosTemp = createVector(gun.x, gun.y);
    let bulletPos = p5.Vector.add(bulletTemp, gunPosTemp);

    let bullet = new bullets.Sprite(bulletPos.x, bulletPos.y);

    bullet.diameter = 9;
    bullet.color = "blue";
    bullet.direction = gun.rotation;
    bullet.speed = random(9, 10);
    bullet.collider = "d";
    bullet.layer = 1;
    bullet.life = gun.range;
    bullet.mass = 10;
    gun.bulletArray.push(bullet);
  }

}

function updateBullets(gun) {
  if (gun.gunType === "shotgun") {
    for (let i = gun.bulletArray.length - 1; i >= 0; i--) {
      let bullet = gun.bulletArray[i];

      bullet.scale *= 0.995;

    }
  }
}

function keyTyped() {
  if(key === "o") {
    camera.zoom += 0.2;
  }
  if(key === "p") {
    camera.zoom -= 0.2;
  }
}


function updateEnemies() {
  for (let enem of enemies) {
    let x = player.x + random(-100, 100);
    let y = player.y + random(-100, 100);
    let speed = 5;
    enem.moveTo(x, y, speed);
  }
}

function initGui() {
  box1 = new Sprite(player.x + 220, player.y + 160);
  // box1.autoDraw = false;
  box1.img = box1Img;
  box1.layer = 6;
  box1.removeColliders();
  box1.scale = 1.5;

  shotgunIcon = new Sprite();
  shotgunIcon.layer = 7;
  shotgunIcon.img = shotgunIconImg;
  shotgunIcon.rotate(-35);
  shotgunIcon.removeColliders();
  shotgunIcon.scale = 0.07;
  shotgunIcon.visible = false;
}

function initGuns() {
  shotgun = new guns.Sprite(player.x, player.y);
  shotgun.unequip = function() {
    shotgun.img = shotgunIconImg;
    shotgun.removeColliders();
    shotgun.scale = 0.07;
  }
  shotgun.unequip();
  // shotgun.offset.y += -5;
  // shotgun.offset.x += 35;
  shotgun.layer = 2;
  shotgun.gunType = "shotgun";
  shotgun.range = 25;
  shotgun.len = 53;
  shotgun.rotationLock = true;
  shotgun.bulletArray = [];

  shotgun.equip = function() {
  shotgun.img = shotgunImg;
  shotgun.removeColliders();
  shotgun.offset.y = -5;
  shotgun.offset.x = 35;
  shotgun.scale = 0.9;
  }
}

function updateGui() {
  box1.x = player.x + 220;
  box1.y = player.y + 160;
  for(let gun of equippedGuns) {
    if(gun.equipped) {
      gun.icon.x = box1.x + 3;
      gun.icon.y = box1.y;
      gun.icon.visible = true;
    }
  }
}